<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fustor Management Console</title>
    <style>
        :root {
            --bg: #0f1117;
            --surface: #1a1d27;
            --surface-hover: #232733;
            --border: #2a2e3b;
            --text: #e4e6eb;
            --text-secondary: #8b8fa3;
            --accent: #6c5ce7;
            --accent-glow: rgba(108, 92, 231, 0.15);
            --green: #00d68f;
            --red: #ff6b6b;
            --yellow: #ffd93d;
            --blue: #4ecdc4;
            --radius: 10px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--surface) 0%, #1e2030 100%);
            border-bottom: 1px solid var(--border);
            padding: 16px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header h1 {
            font-size: 20px;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent), var(--blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .refresh-info {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Content */
        .content { padding: 24px 32px; max-width: 1400px; margin: 0 auto; }

        /* Stats bar */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px 20px;
            transition: border-color 0.2s;
        }
        .stat-card:hover { border-color: var(--accent); }
        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        .stat-value {
            font-size: 28px;
            font-weight: 700;
        }

        /* Section */
        .section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 20px;
            overflow: hidden;
        }
        .section-header {
            padding: 14px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .section-title {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Table */
        table { width: 100%; border-collapse: collapse; }
        th {
            padding: 10px 16px;
            text-align: left;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-secondary);
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
        }
        td {
            padding: 12px 16px;
            font-size: 13px;
            border-bottom: 1px solid var(--border);
        }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: var(--surface-hover); }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        .badge-green { background: rgba(0, 214, 143, 0.15); color: var(--green); }
        .badge-red { background: rgba(255, 107, 107, 0.15); color: var(--red); }
        .badge-yellow { background: rgba(255, 217, 61, 0.15); color: var(--yellow); }
        .badge-blue { background: rgba(78, 205, 196, 0.15); color: var(--blue); }
        .badge-purple { background: var(--accent-glow); color: var(--accent); }

        /* Buttons */
        .btn {
            padding: 7px 16px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn:hover {
            background: var(--surface-hover);
            border-color: var(--accent);
        }
        .btn-primary {
            background: var(--accent);
            border-color: var(--accent);
        }
        .btn-primary:hover {
            background: #7c6df0;
        }
        .btn-sm { padding: 4px 10px; font-size: 11px; }

        /* Loading / Error */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        .error-msg {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid var(--red);
            border-radius: var(--radius);
            padding: 12px 20px;
            color: var(--red);
            margin-bottom: 20px;
        }

        /* Mono text */
        .mono { font-family: 'JetBrains Mono', 'Fira Code', monospace; font-size: 12px; }

        /* Grid layout */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 900px) { .grid-2 { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="header">
        <h1>⚡ Fustor Management Console</h1>
        <div class="header-actions">
            <span class="refresh-info" id="lastRefresh">-</span>
            <button class="btn" onclick="refresh()">↻ Refresh</button>
            <button class="btn btn-primary" onclick="reloadFusion()">⟳ Reload Fusion</button>
        </div>
    </div>

    <div class="content">
        <div id="error"></div>

        <!-- Stats Bar -->
        <div class="stats-bar" id="statsBar">
            <div class="stat-card"><div class="stat-label">Agents</div><div class="stat-value" id="statAgents">-</div></div>
            <div class="stat-card"><div class="stat-label">Pipes</div><div class="stat-value" id="statPipes">-</div></div>
            <div class="stat-card"><div class="stat-label">Views</div><div class="stat-value" id="statViews">-</div></div>
            <div class="stat-card"><div class="stat-label">Sessions</div><div class="stat-value" id="statSessions">-</div></div>
        </div>

        <!-- Agents & Pipes -->
        <div class="grid-2">
            <!-- Agents -->
            <div class="section">
                <div class="section-header">
                    <span class="section-title">Connected Agents</span>
                </div>
                <table>
                    <thead><tr><th>Agent ID</th><th>IP</th><th>Sessions</th><th>Actions</th></tr></thead>
                    <tbody id="agentsBody"><tr><td colspan="4" class="loading">Loading...</td></tr></tbody>
                </table>
            </div>

            <!-- Pipes -->
            <div class="section">
                <div class="section-header">
                    <span class="section-title">Fusion Pipes</span>
                </div>
                <table>
                    <thead><tr><th>Pipe ID</th><th>View</th><th>Sessions</th><th>Status</th></tr></thead>
                    <tbody id="pipesBody"><tr><td colspan="4" class="loading">Loading...</td></tr></tbody>
                </table>
            </div>
        </div>

        <!-- Sessions -->
        <div class="section">
            <div class="section-header">
                <span class="section-title">Active Sessions</span>
            </div>
            <table>
                <thead><tr>
                    <th>Session ID</th><th>View</th><th>Agent</th><th>Role</th>
                    <th>Realtime</th><th>Age</th><th>Idle</th><th>Events</th>
                </tr></thead>
                <tbody id="sessionsBody"><tr><td colspan="8" class="loading">Loading...</td></tr></tbody>
            </table>
        </div>

        <!-- Config -->
        <div class="section">
            <div class="section-header">
                <span class="section-title">Configuration</span>
                <button class="btn btn-sm" onclick="toggleConfig()">Show/Hide</button>
            </div>
            <div id="configPanel" style="display:none; padding: 16px;">
                <pre class="mono" id="configContent" style="white-space: pre-wrap; color: var(--text-secondary);">Loading...</pre>
            </div>
        </div>
    </div>

    <script>
    const API = '/api/v1/management';
    let autoRefreshTimer = null;

    async function api(path, opts = {}) {
        const res = await fetch(API + path, opts);
        if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
        return res.json();
    }

    function showError(msg) {
        const el = document.getElementById('error');
        el.innerHTML = msg ? `<div class="error-msg">${msg}</div>` : '';
    }

    function badge(text, type) {
        return `<span class="badge badge-${type}">${text}</span>`;
    }

    function formatAge(seconds) {
        if (seconds == null) return '-';
        if (seconds < 60) return Math.round(seconds) + 's';
        if (seconds < 3600) return Math.round(seconds / 60) + 'm';
        return Math.round(seconds / 3600) + 'h';
    }

    async function refresh() {
        try {
            showError('');
            const data = await api('/dashboard');
            renderDashboard(data);
            document.getElementById('lastRefresh').textContent =
                'Updated: ' + new Date().toLocaleTimeString();
        } catch (e) {
            showError('Failed to load dashboard: ' + e.message);
        }
    }

    function renderDashboard(data) {
        const agents = data.agents || {};
        const pipes = data.pipes || {};
        const sessions = data.sessions || {};

        // Stats
        let totalSessions = 0;
        Object.values(sessions).forEach(arr => totalSessions += arr.length);

        document.getElementById('statAgents').textContent = Object.keys(agents).length;
        document.getElementById('statPipes').textContent = Object.keys(pipes).length;
        document.getElementById('statViews').textContent = Object.keys(data.views || {}).length;
        document.getElementById('statSessions').textContent = totalSessions;

        // Agents table
        const agentsHtml = Object.entries(agents).map(([id, a]) => {
            const status = a.status;
            const evts = status ? (status.events_pushed || 0) : '-';
            return `<tr>
                <td class="mono">${id}</td>
                <td class="mono">${a.client_ip || '-'}</td>
                <td>${a.sessions ? a.sessions.length : 0}</td>
                <td>
                    <button class="btn btn-sm" onclick="sendCmd('${id}','reload_config')">Reload</button>
                </td>
            </tr>`;
        }).join('');
        document.getElementById('agentsBody').innerHTML =
            agentsHtml || '<tr><td colspan="4" style="text-align:center;color:var(--text-secondary)">No agents connected</td></tr>';

        // Pipes table
        const pipesHtml = Object.entries(pipes).map(([id, p]) => {
            const sessCnt = p.active_sessions ? Object.keys(p.active_sessions).length : 0;
            const state = p.state || 'unknown';
            let stateBadge = badge(state, 'yellow');
            if (state.includes('RUNNING')) stateBadge = badge('RUNNING', 'green');
            if (state.includes('ERROR')) stateBadge = badge('ERROR', 'red');
            if (state.includes('STOPPED')) stateBadge = badge('STOPPED', 'red');

            return `<tr>
                <td class="mono">${id}</td>
                <td class="mono">${p.view_id || id}</td>
                <td>${sessCnt}</td>
                <td>${stateBadge}</td>
            </tr>`;
        }).join('');
        document.getElementById('pipesBody').innerHTML =
            pipesHtml || '<tr><td colspan="4" style="text-align:center;color:var(--text-secondary)">No pipes</td></tr>';

        // Sessions table
        let sessionsHtml = '';
        for (const [viewId, sessArr] of Object.entries(sessions)) {
            for (const s of sessArr) {
                const agentStatus = s.agent_status || {};
                const role = agentStatus.role || '-';
                const roleBadge = role === 'leader' ? badge('LEADER', 'purple') : badge(role, 'blue');
                const rt = s.can_realtime ? badge('YES', 'green') : badge('NO', 'yellow');
                const evts = agentStatus.events_pushed != null ? agentStatus.events_pushed : '-';

                sessionsHtml += `<tr>
                    <td class="mono" title="${s.session_id}">${s.session_id.substring(0, 8)}…</td>
                    <td class="mono">${viewId}</td>
                    <td class="mono">${s.agent_id || '-'}</td>
                    <td>${roleBadge}</td>
                    <td>${rt}</td>
                    <td>${formatAge(s.age_seconds)}</td>
                    <td>${formatAge(s.idle_seconds)}</td>
                    <td>${evts}</td>
                </tr>`;
            }
        }
        document.getElementById('sessionsBody').innerHTML =
            sessionsHtml || '<tr><td colspan="8" style="text-align:center;color:var(--text-secondary)">No active sessions</td></tr>';
    }

    async function sendCmd(agentId, type, extra = {}) {
        try {
            const body = { type, ...extra };
            const res = await api(`/agents/${agentId}/command`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
            });
            alert(`Command sent: ${res.sessions_queued} sessions queued`);
            refresh();
        } catch (e) {
            alert('Failed: ' + e.message);
        }
    }

    async function reloadFusion() {
        if (!confirm('Reload Fusion configuration?')) return;
        try {
            await api('/reload', { method: 'POST' });
            alert('Reload triggered');
            setTimeout(refresh, 1000);
        } catch (e) {
            alert('Reload failed: ' + e.message);
        }
    }

    async function toggleConfig() {
        const panel = document.getElementById('configPanel');
        if (panel.style.display === 'none') {
            panel.style.display = 'block';
            try {
                const cfg = await api('/config');
                document.getElementById('configContent').textContent = JSON.stringify(cfg, null, 2);
            } catch (e) {
                document.getElementById('configContent').textContent = 'Error: ' + e.message;
            }
        } else {
            panel.style.display = 'none';
        }
    }

    // Auto-refresh every 5 seconds
    refresh();
    autoRefreshTimer = setInterval(refresh, 5000);
    </script>
</body>
</html>
