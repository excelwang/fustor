<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>实时元数据整合演示</title>
    <style>
        /* CSS样式与您提供的一致，此处省略以保持简洁 */
        :root {
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --color-bg: #f4f7f6;
            --color-panel-bg: #ffffff;
            --color-header-text: #1a237e; /* 学术深蓝 */
            --color-text-primary: #212121;
            --color-text-secondary: #5f6368;
            --color-border: #dfe1e5;
            --color-live: #d93025; /* 红色 "Live" 状态 */
            --color-latency-good: #34a853;
            --color-latency-medium: #fbbc04;
            --color-latency-bad: #ea4335;
            --icon-folder: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%235f6368' viewBox='0 0 16 16'%3E%3Cpath d='M.54 3.87.5 3a2 2 0 0 1 2-2h3.672a2 2 0 0 1 1.414.586l.828.828A2 2 0 0 0 9.828 3h3.982a2 2 0 0 1 2 2v1h-16v-1a2 2 0 0 1 2-2h.54zM0 6v7a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6H0z'/%3E%3C/svg%3E");
            --icon-file: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%235f6368' viewBox='0 0 16 16'%3E%3Cpath d='M4 0h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2zm0 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H4z'/%3E%3C/svg%3E");
        }
        body { font-family: var(--font-family); background-color: var(--color-bg); margin: 0; padding: 1rem; color: var(--color-text-primary); display: flex; min-height: calc(100vh - 2rem); overflow: hidden; }
        main { display: flex; flex-grow: 1; gap: 1.5rem; width: 100%; }
        main > .panel.gsa-panel { flex: 2; }
        main > .panel.stats-panel { flex: 1; }
        .panel { display: flex; flex-direction: column; background: var(--color-panel-bg); border: 1px solid var(--color-border); border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.06); overflow: hidden; }
        .panel-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .panel-header h2 { margin: 0; color: var(--color-header-text); font-weight: 600; }
        .status-indicator { display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; font-weight: 500; color: var(--color-live); }
        .status-indicator::before { content: ''; width: 8px; height: 8px; background-color: var(--color-live); border-radius: 50%; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        .content-area { flex-grow: 1; padding: 1.5rem; overflow-y: auto; font-size: 0.9rem; line-height: 1.5; }
        .loading-text, .error-text, .no-data { color: var(--color-text-secondary); font-style: italic; }
        .error-text { color: var(--color-live); font-weight: 500; }
        .tree-view { font-family: "Menlo", "Consolas", monospace; }
        .tree-item { display: flex; align-items: center; padding: 0.15rem 0; white-space: nowrap; }
        .tree-children.collapsed { display: none; }
        .tree-caret { width: 16px; height: 16px; flex-shrink: 0; cursor: pointer; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%235f6368' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: center; transition: transform 0.2s ease-in-out; }
        .tree-caret.expanded { transform: rotate(90deg); }
        .tree-placeholder { width: 16px; height: 16px; flex-shrink: 0; }
        .tree-item .icon { width: 16px; height: 16px; flex-shrink: 0; margin: 0 0.25rem; }
        .tree-item.type-folder .icon { background: var(--icon-folder) no-repeat center center; }
        .tree-item.type-file .icon { background: var(--icon-file) no-repeat center center; }
        .tree-item.type-folder .name { font-weight: 600; }
        .stats-panel .content-area { display: flex; flex-direction: column; gap: 1.5rem; background-color: #f8f9fa; }
        .stat-card { background-color: var(--color-panel-bg); border: 1px solid var(--color-border); border-radius: 6px; padding: 1rem; }
        .stat-card h4 { margin: 0 0 0.5rem 0; font-weight: 500; font-size: 0.9rem; color: var(--color-text-secondary); }
        .stat-card .value { font-family: "Menlo", "Consolas", monospace; font-weight: 600; font-size: 1.75rem; color: var(--color-header-text); }
        .stat-card .unit { font-size: 0.8rem; margin-left: 0.5rem; color: var(--color-text-secondary); }
        .stat-bar-container { background-color: #e9ecef; border-radius: 4px; height: 8px; margin-top: 1rem; overflow: hidden; }
        .stat-bar { height: 100%; width: 0%; border-radius: 4px; background-color: var(--color-latency-good); transition: width 0.3s ease-out, background-color 0.3s ease-out; }
        .stat-bar.latency-good { background-color: var(--color-latency-good); }
        .stat-bar.latency-medium { background-color: var(--color-latency-medium); }
        .stat-bar.latency-bad { background-color: var(--color-latency-bad); }
        .staleness-grid { font-family: "Menlo", "Consolas", monospace; font-size: 0.85rem; display: grid; grid-template-columns: auto 1fr; gap: 0.75rem 1rem; align-items: center; }
        .staleness-grid .level-label { font-weight: 500; color: var(--color-text-secondary); }
        .staleness-grid .level-value { font-weight: 600; color: var(--color-text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .staleness-grid .level-value .days { color: var(--color-header-text); margin-left: 0.5rem; }
        .panel-header .header-controls { display: flex; align-items: center; }
        .control-btn { margin-right: 1rem; padding: 0.3rem 0.8rem; border: 1px solid var(--color-border); border-radius: 4px; background-color: #f8f9fa; cursor: pointer; font-size: 0.8rem; color: var(--color-text-secondary); transition: background-color 0.2s; }
        .control-btn:hover { background-color: #e9ecef; }
    </style>
</head>
<body>
    <main>
        <div class="panel gsa-panel">
            <div class="panel-header">
                <h2>NFS实时目录视图</h2>
                <div class="header-controls">
                    <button id="toggle-refresh-btn" class="control-btn">停止刷新</button>
                    <span class="status-indicator" id="gsa-status">LIVE</span>
                </div>
            </div>
            <div class="content-area" id="gsa-content">
                <div class="loading-text">正在初始化并拉取数据...</div>
            </div>
        </div>
        <div class="panel stats-panel">
            <div class="panel-header">
                <h2>实时统计</h2>
            </div>
            <div class="content-area">
                <div class="stat-card">
                    <h4>总数据量</h4>
                    <div>
                        <span class="value" id="stats-volume">--</span>
                        <span class="unit" id="stats-volume-unit"></span>
                    </div>
                </div>
                <div class="stat-card">
                    <h4>同步延迟</h4>
                    <div>
                        <span class="value" id="stats-latency">--</span>
                        <span class="unit">ms</span>
                    </div>
                    <div class="stat-bar-container">
                        <div class="stat-bar" id="latency-bar"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <h4>文件夹陈旧状态</h4>
                    <div class="staleness-grid">
                        <span class="level-label">二级目录:</span><span class="level-value" id="staleness-level-2">--</span>
                        <span class="level-label">三级目录:</span><span class="level-value" id="staleness-level-3">--</span>
                        <span class="level-label">四级目录:</span><span class="level-value" id="staleness-level-4">--</span>
                        <span class="level-label">五级目录:</span><span class="level-value" id="staleness-level-5">--</span>
                    </div>
                </div>
                <div class="stat-card">
                    <h4>剩余存储空间</h4>
                    <div>
                        <span class="value">N/A</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        (function() {
            // --- 1. API 配置 & DOM 引用 ---
            const API_BASE_URL = '/ingest-api/v1/events';
            const API_HEADERS = { 
                'accept': 'application/json',
                'x-api-key': 'JrL1Eee4bl2ZVDmQ-3YBx36SOXilL9EE77QhsjG1m-Q'
            };
            const eventsEl = document.getElementById('gsa-content');
            let errorCount = 0;
            
            const STATS_API_URL = `${API_BASE_URL}/stats`;
            const EVENTS_API_URL = `${API_BASE_URL}/latest/100`;
            const STATS_POLLING_INTERVAL = 2000;
            const EVENTS_POLLING_INTERVAL = 500;
            
            const statsVolumeEl = document.getElementById('stats-volume');
            const statsVolumeUnitEl = document.getElementById('stats-volume-unit');
            const statsLatencyEl = document.getElementById('stats-latency');
            const latencyBarEl = document.getElementById('latency-bar');
            const stalenessLevelEls = {
                2: document.getElementById('staleness-level-2'),
                3: document.getElementById('staleness-level-3'),
                4: document.getElementById('staleness-level-4'),
                5: document.getElementById('staleness-level-5'),
            };

            // --- 2. 核心数据拉取函数 ---
            async function fetchData(url) {
                const response = await fetch(url, { method: 'GET', headers: API_HEADERS, mode: 'cors' });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            }

            // --- 3. 渲染与交互逻辑 ---
            function buildFileTree(data) {
                const root = { type: 'root', children: {} };
                for (const event of data) {
                    let eventContent = event.content;
                    // Handle the nested structure
                    if (eventContent?.events?.content) {
                        eventContent = eventContent.events.content;
                    }

                    // Now, eventContent is either a string (file path) or an object
                    const filePath = typeof eventContent === 'string' ? eventContent : eventContent.file_path;

                    if (!filePath) continue;

                    const parts = filePath.split('/').filter(Boolean);
                    let currentNode = root;
                    for (let i = 0; i < parts.length; i++) {
                        const part = parts[i];
                        const isLastPart = i === parts.length - 1;
                        if (!currentNode.children[part]) {
                            currentNode.children[part] = isLastPart 
                                ? { type: 'file', ...(typeof eventContent === 'object' ? eventContent : { file_path: filePath }) }
                                : { type: 'folder', children: {} };
                        }
                        if (!isLastPart) {
                            currentNode = currentNode.children[part];
                        }
                    }
                }
                return root;
            }
            
            function renderTreeView(treeNode, depth = 0) {
                const fragment = document.createDocumentFragment();
                const childKeys = Object.keys(treeNode.children).sort((a, b) => a.localeCompare(b, undefined, {numeric: true}));
                for (const key of childKeys) {
                    const child = treeNode.children[key];
                    const itemEl = document.createElement('div');
                    itemEl.className = 'tree-item';
                    itemEl.style.paddingLeft = `${depth * 24}px`;
                    if (child.type === 'folder') {
                        itemEl.classList.add('type-folder');
                        const childrenId = `tree-children-${Math.random().toString(36).substring(2, 9)}`;
                        const isCollapsed = depth >= 10;
                        const caretClass = isCollapsed ? 'tree-caret' : 'tree-caret expanded';
                        const childrenClass = isCollapsed ? 'tree-children collapsed' : 'tree-children';
                        itemEl.innerHTML = `<span class="${caretClass}" data-target="${childrenId}"></span><span class="icon"></span><span class="name">${escapeHTML(key)}</span>`;
                        fragment.appendChild(itemEl);
                        const childrenContainer = document.createElement('div');
                        childrenContainer.id = childrenId;
                        childrenContainer.className = childrenClass;
                        childrenContainer.appendChild(renderTreeView(child, depth + 1));
                        fragment.appendChild(childrenContainer);
                    } else {
                        itemEl.classList.add('type-file');
                        itemEl.innerHTML = `<span class="tree-placeholder"></span><span class="icon"></span><span class="name">${escapeHTML(key)}</span>`;
                        fragment.appendChild(itemEl);
                    }
                }
                return fragment;
            }

            function renderEventView(data) {
                if (!data || data.length === 0) {
                    eventsEl.innerHTML = '<div class="no-data">等待新的事件数据...</div>';
                    return;
                }
                calculateAndRenderOtherStats(data);
                const tree = buildFileTree(data);
                eventsEl.innerHTML = '';
                const treeViewContainer = document.createElement('div');
                treeViewContainer.className = 'tree-view';
                treeViewContainer.appendChild(renderTreeView(tree, 0));
                eventsEl.appendChild(treeViewContainer);
            }
            
            function renderError(error) {
                errorCount++;
                eventsEl.innerHTML = `<div class="error-text">数据拉取失败: ${escapeHTML(error.message)} (已连续失败 ${errorCount} 次)</div>`;
                resetStats();
            }

            // --- 4. 统计计算与渲染 ---
            function renderStats(statsData) {
                const totalSize = statsData.total_size_bytes;
                const formattedSize = formatBytes(totalSize);
                statsVolumeEl.textContent = formattedSize.value;
                statsVolumeUnitEl.textContent = formattedSize.unit;
            }

            function calculateAndRenderOtherStats(eventData) {
                let syncLatency = null;
                if (eventData && eventData.length > 0) {
                    const latestEvent = eventData.reduce((latest, current) => 
                        (!latest || new Date(current.created_at) > new Date(latest.created_at)) ? current : latest
                    );

                    let eventContent = latestEvent.content;
                    if (eventContent?.events?.content) {
                        eventContent = eventContent.events.content;
                    }

                    const modifiedTime = eventContent?.modified_time;

                    if (latestEvent && latestEvent.created_at && modifiedTime) {
                        
                        // --- 核心修改在这里 ---
                        // 1. 获取来自后端的、不带时区信息的 created_at 字符串
                        let createdAtString = latestEvent.created_at;

                        // 2. 检查字符串是否缺少时区信息 (不以'Z'结尾，且倒数第6位不是'+'或'-')
                        if (!createdAtString.endsWith('Z') && !['+','-'].includes(createdAtString.slice(-6, -5))) {
                            // 3. 假设该时间是后端服务器的CST (UTC+8)时区，手动为其补上时区偏移
                            createdAtString += "+08:00";
                        }
                        
                        // 4. 使用修正后的字符串创建Date对象
                        const createdAt = new Date(createdAtString);
                        const modifiedAt = new Date(modifiedTime * 1000);
                        syncLatency = createdAt.getTime() - modifiedAt.getTime();
                    }
                }

                if(syncLatency !== null) {
                    statsLatencyEl.textContent = syncLatency;
                    const maxLatencyForBar = 2000;
                    const latencyPercentage = Math.min(100, (syncLatency / maxLatencyForBar) * 100);
                    latencyBarEl.style.width = `${latencyPercentage}%`;
                    latencyBarEl.className = 'stat-bar';
                    if (syncLatency > 1500) latencyBarEl.classList.add('latency-bad');
                    else if (syncLatency > 500) latencyBarEl.classList.add('latency-medium');
                    else latencyBarEl.classList.add('latency-good');
                } else {
                    statsLatencyEl.textContent = '--';
                    latencyBarEl.style.width = '0%';
                }

                const stalenessResults = calculateStalenessByLevel(eventData);
                for (let level = 2; level <= 5; level++) {
                    const el = stalenessLevelEls[level];
                    const result = stalenessResults[level];
                    if (result) {
                        el.innerHTML = `${escapeHTML(result.path)} <span class="days">(${result.days} 天)</span>`;
                        el.title = `${result.path} (${result.days} 天未更新)`;
                    } else {
                        el.textContent = '无';
                        el.title = '';
                    }
                }
            }

            function calculateStalenessByLevel(data) {
                const folderLatestTimes = new Map();
                for (const event of data) {
                    let eventContent = event.content;
                    if (eventContent?.events?.content) {
                        eventContent = eventContent.events.content;
                    }

                    const filePath = eventContent?.file_path;
                    const modifiedTime = eventContent?.modified_time;

                    if (!filePath || !modifiedTime) continue;

                    const fileModifiedDate = new Date(modifiedTime * 1000);
                    const parts = filePath.split('/').filter(Boolean);
                    let currentPath = '';
                    for (let i = 0; i < parts.length - 1; i++) {
                        currentPath += `/${parts[i]}`;
                        const existingTime = folderLatestTimes.get(currentPath);
                        if (!existingTime || fileModifiedDate > existingTime) {
                            folderLatestTimes.set(currentPath, fileModifiedDate);
                        }
                    }
                }
                const foldersByLevel = { 2: [], 3: [], 4: [], 5: [] };
                for (const [path, time] of folderLatestTimes.entries()) {
                    const level = path.split('/').length - 1;
                    if (foldersByLevel[level]) {
                        foldersByLevel[level].push({ path, time });
                    }
                }
                const now = new Date();
                const results = { 2: null, 3: null, 4: null, 5: null };
                for (let level = 2; level <= 5; level++) {
                    if (foldersByLevel[level].length > 0) {
                        const oldest = foldersByLevel[level].reduce((oldest, current) => (current.time < oldest.time ? current : oldest));
                        results[level] = { path: oldest.path, days: Math.floor((now - oldest.time) / 86400000) };
                    }
                }
                return results;
            }
            
            function resetStats() {
                statsVolumeEl.textContent = '--';
                statsVolumeUnitEl.textContent = '';
                statsLatencyEl.textContent = '--';
                latencyBarEl.style.width = '0%';
                for (let level = 2; level <= 5; level++) {
                    stalenessLevelEls[level].textContent = '--';
                    stalenessLevelEls[level].title = '';
                }
            }

            // --- 5. 辅助工具 & 启动轮询 ---
            function formatBytes(bytes, decimals = 2) {
                if (bytes === 0) return { value: '0', unit: 'Bytes' };
                const k = 1024;
                const dm = decimals < 0 ? 0 : decimals;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return { value: parseFloat((bytes / Math.pow(k, i)).toFixed(dm)), unit: sizes[i] };
            }
            
            function escapeHTML(str) {
                if (str === null || str === undefined) return '';
                return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);
            }
            
            async function pollEvents() {
                try {
                    const eventData = await fetchData(EVENTS_API_URL);
                    renderEventView(eventData);
                    errorCount = 0;
                } catch(error) {
                    renderError(error);
                }
            }

            async function pollStats() {
                try {
                    const statsData = await fetchData(STATS_API_URL);
                    renderStats(statsData);
                } catch(error) {
                    console.error("Failed to fetch stats:", error);
                    resetStats();
                }
            }
            
            eventsEl.addEventListener('click', function (e) {
                const caret = e.target.closest('.tree-caret');
                if (!caret) return;
                const targetId = caret.dataset.target;
                const childrenContainer = document.getElementById(targetId);
                if (childrenContainer) {
                    caret.classList.toggle('expanded');
                    childrenContainer.classList.toggle('collapsed');
                }
            });

            // 启动轮询控制
            let eventsIntervalId = null;
            let statsIntervalId = null;
            let isPolling = false; 
            const toggleRefreshBtn = document.getElementById('toggle-refresh-btn');
            const gsaStatusEl = document.getElementById('gsa-status');

            function startPolling() {
                if (isPolling) return;

                pollEvents();
                pollStats();

                eventsIntervalId = setInterval(pollEvents, EVENTS_POLLING_INTERVAL);
                statsIntervalId = setInterval(pollStats, STATS_POLLING_INTERVAL);
                
                isPolling = true;
                toggleRefreshBtn.textContent = '停止刷新';
                gsaStatusEl.style.display = 'flex';
            }

            function stopPolling() {
                if (!isPolling) return;

                clearInterval(eventsIntervalId);
                clearInterval(statsIntervalId);
                eventsIntervalId = null;
                statsIntervalId = null;
                
                isPolling = false;
                toggleRefreshBtn.textContent = '开始刷新';
                gsaStatusEl.style.display = 'none';
            }

            toggleRefreshBtn.addEventListener('click', () => {
                if (isPolling) {
                    stopPolling();
                } else {
                    startPolling();
                }
            });

            // 启动轮询
            startPolling();
        })();
    </script>
</body>
</html>