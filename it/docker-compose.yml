# version is obsolete in compose v2
# Fustor NFS Multi-Mount Consistency Integration Test Environment

# Fustor NFS Multi-Mount Consistency Integration Test Environment
# This setup simulates a real NFS multi-client scenario with:
# - NFS Server: exports shared directory
# - NFS Client A/B: with Fustor Agents (Leader/Follower)
# - NFS Client C: no Agent (blind-spot simulation)
# - Fusion: central service

services:
  # ============ Infrastructure Services ============

  nfs-server:
    image: erichough/nfs-server
    container_name: fustor-nfs-server
    privileged: true
    environment:
      NFS_EXPORT_0: "/exports *(rw,sync,no_subtree_check,no_root_squash)"
    volumes:
      - nfs-data:/exports
    networks:
      - fustor-net
    healthcheck:
      test: [ "CMD", "showmount", "-e", "localhost" ]
      interval: 5s
      timeout: 3s
      retries: 30

  fusion:
    build:
      context: ..
      dockerfile: it/containers/fustor-services/Dockerfile
    container_name: fustor-fusion
    command: [ "fustor-fusion", "start", "-h", "0.0.0.0" ]
    environment:
      FUSTOR_FUSION_HOST: "0.0.0.0"
      FUSTOR_FUSION_PORT: "8102"
      FUSTOR_FUSION_DATA_DIR: "/data/fusion"
      # Faster cache sync for integration tests (reloads YAML)
      FUSTOR_FUSION_API_KEY_CACHE_SYNC_INTERVAL_SECONDS: "1"
      # Accelerate failover tests
      FUSTOR_FUSION_SESSION_TIMEOUT_SECONDS: "4"
      FUSTOR_LOG_LEVEL: "DEBUG"
      # Use home directory for config
      FUSTOR_HOME: "/root/.fustor"
    volumes:
      - fusion-data:/data/fusion
      - ../fusion/src/fustor_fusion:/usr/local/lib/python3.11/site-packages/fustor_fusion
      - ../packages/core/src/fustor_core:/usr/local/lib/python3.11/site-packages/fustor_core
      - ../packages/fusion-sdk/src/fustor_fusion_sdk:/usr/local/lib/python3.11/site-packages/fustor_fusion_sdk
      - ../packages/view-fs/src/fustor_view_fs:/usr/local/lib/python3.11/site-packages/fustor_view_fs
      - ../packages/receiver-http/src/fustor_receiver_http:/usr/local/lib/python3.11/site-packages/fustor_receiver_http

    ports:
      - "18102:8102"
    networks:
      - fustor-net
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8102/" ]
      interval: 5s
      timeout: 3s
      retries: 30

  # ============ NFS Clients with Agents ============

  nfs-client-a:
    build:
      context: ..
      dockerfile: it/containers/nfs-client/Dockerfile
    container_name: fustor-nfs-client-a
    privileged: true
    cap_add:
      - SYS_ADMIN
    environment:
      NFS_SERVER: "nfs-server"
      NFS_PATH: "/exports"
      MOUNT_POINT: "/mnt/shared"
      MOUNT_OPTIONS: "actimeo=1,nolock"
      AGENT_ENABLED: "false"
      AGENT_ID: "agent-a"
      AGENT_PORT: "8100"
      FUSION_ENDPOINT: "http://fusion:8102"
      LD_PRELOAD: "/usr/lib/x86_64-linux-gnu/faketime/libfaketime.so.1"
      FAKETIME: "+2 hours"
    volumes:
      - agent-a-data:/data/agent
      - ../agent/src/fustor_agent:/usr/local/lib/python3.11/site-packages/fustor_agent
      - ../packages/source-fs/src/fustor_source_fs:/usr/local/lib/python3.11/site-packages/fustor_source_fs
      - ../packages/sender-http/src/fustor_sender_http:/usr/local/lib/python3.11/site-packages/fustor_sender_http
      - ../packages/sender-echo/src/fustor_sender_echo:/usr/local/lib/python3.11/site-packages/fustor_sender_echo
      - ../packages/core/src/fustor_core:/usr/local/lib/python3.11/site-packages/fustor_core
      - ../packages/agent-sdk/src/fustor_agent_sdk:/usr/local/lib/python3.11/site-packages/fustor_agent_sdk
      - ../packages/fusion-sdk/src/fustor_fusion_sdk:/usr/local/lib/python3.11/site-packages/fustor_fusion_sdk
    ports:
      - "18100:8100"
    networks:
      - fustor-net
    depends_on:
      nfs-server:
        condition: service_healthy
      fusion:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "test", "-d", "/mnt/shared" ]
      interval: 5s
      timeout: 3s
      retries: 30

  nfs-client-b:
    build:
      context: ..
      dockerfile: it/containers/nfs-client/Dockerfile
    container_name: fustor-nfs-client-b
    privileged: true
    cap_add:
      - SYS_ADMIN
    environment:
      NFS_SERVER: "nfs-server"
      NFS_PATH: "/exports"
      MOUNT_POINT: "/mnt/shared"
      MOUNT_OPTIONS: "actimeo=1,nolock"
      AGENT_ENABLED: "false"
      AGENT_ID: "agent-b"
      AGENT_PORT: "8100"
      FUSION_ENDPOINT: "http://fusion:8102"
      LD_PRELOAD: "/usr/lib/x86_64-linux-gnu/faketime/libfaketime.so.1"
      FAKETIME: "-1h"
    volumes:
      - agent-b-data:/data/agent
      - ../agent/src/fustor_agent:/usr/local/lib/python3.11/site-packages/fustor_agent
      - ../packages/source-fs/src/fustor_source_fs:/usr/local/lib/python3.11/site-packages/fustor_source_fs
      - ../packages/sender-http/src/fustor_sender_http:/usr/local/lib/python3.11/site-packages/fustor_sender_http
      - ../packages/sender-echo/src/fustor_sender_echo:/usr/local/lib/python3.11/site-packages/fustor_sender_echo
      - ../packages/core/src/fustor_core:/usr/local/lib/python3.11/site-packages/fustor_core
      - ../packages/agent-sdk/src/fustor_agent_sdk:/usr/local/lib/python3.11/site-packages/fustor_agent_sdk
      - ../packages/fusion-sdk/src/fustor_fusion_sdk:/usr/local/lib/python3.11/site-packages/fustor_fusion_sdk
    ports:
      - "18103:8100"
    networks:
      - fustor-net
    depends_on:
      nfs-server:
        condition: service_healthy
      fusion:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "test", "-d", "/mnt/shared" ]
      interval: 5s
      timeout: 3s
      retries: 30

  # ============ NFS Client without Agent (Blind-spot Simulation) ============

  nfs-client-c:
    build:
      context: ..
      dockerfile: it/containers/nfs-client/Dockerfile
    container_name: fustor-nfs-client-c
    privileged: true
    cap_add:
      - SYS_ADMIN
    environment:
      NFS_SERVER: "nfs-server"
      NFS_PATH: "/exports"
      MOUNT_POINT: "/mnt/shared"
      MOUNT_OPTIONS: "actimeo=1,nolock"
      AGENT_ENABLED: "false"
    networks:
      - fustor-net
    depends_on:
      nfs-server:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "test", "-d", "/mnt/shared" ]
      interval: 5s
      timeout: 3s
      retries: 30

networks:
  fustor-net:
    driver: bridge

volumes:
  nfs-data:
  fusion-data:
  agent-a-data:
  agent-b-data:
