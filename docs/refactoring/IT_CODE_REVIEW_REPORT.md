# é›†æˆæµ‹è¯•å¼€å‘ä»£ç è¯„å®¡æŠ¥å‘Š (ç»¼åˆç‰ˆ)

> **è¯„å®¡æ—¶é—´**: 2026-02-02  
> **è¯„å®¡èŒƒå›´**: Commits dc9684b â†’ be8d030  
> **å¯¹æ¯”åŸºå‡†**: bcccf7f ("cleanup")  
> **æ€»å˜æ›´**: 35 files (+464 lines, -355 lines)

---

## ä¸€ã€ä»»åŠ¡è¿›åº¦è¿½è¸ª

åŸºäº `REFACTORED_TESTS_REVIEW_REPORT.md` ä¸­çš„ TODO æ¸…å•ï¼š

### ğŸ“Š æ€»ä½“è¿›åº¦

| ä¼˜å…ˆçº§ | å·²å®Œæˆ | å¾…å®Œæˆ | å®Œæˆç‡ |
|--------|--------|--------|--------|
| ğŸ”´ **é«˜** | 5/5 | 0 | **100%** âœ… |
| ğŸŸ¡ ä¸­ | 4/5 | 1 | 80% |
| ğŸŸ¢ ä½ | 1/5 | 4 | 20% |

**é«˜ä¼˜å…ˆçº§ä»»åŠ¡å…¨éƒ¨å®Œæˆï¼** ğŸ‰

### âœ… å·²å®Œæˆä»»åŠ¡

| TODO ID | ä»»åŠ¡æè¿° | çŠ¶æ€ | å®ç°æ–‡ä»¶ |
|---------|----------|------|----------|
| **TODO-IT-001** | æ¸…ç† Legacy æ¨¡å¼ä»£ç  | âœ… | `conftest.py`, `fixtures/agents.py`, `fixtures/__init__.py` |
| **TODO-IT-002** | ä¿®å¤æ ‘éå†é€»è¾‘ | âœ… | `test_pipeline_basic.py` - ä½¿ç”¨ `wait_for_file_in_tree()` |
| **TODO-IT-003** | Sentinel å®Œæ•´æµç¨‹æµ‹è¯• | âœ… | `test_c5_sentinel_sweep.py` é‡å†™ |
| **TODO-IT-004** | SessionObsoletedError æ¢å¤æµ‹è¯• | âœ… | `test_a3_session_recovery.py` + 419 å¤„ç†å®ç° |
| **TODO-IT-006** | è¿ç§» `test_consistency_logic.py` | âœ… | æ–‡ä»¶ç§»åŠ¨åˆ° `packages/view-fs/tests/` |
| **TODO-IT-007** | ç»Ÿä¸€é‡è¯•ç­–ç•¥ | âœ… | `docker_manager.py` - å†…ç½®é‡è¯•é€»è¾‘ |
| **TODO-IT-008** | ç»Ÿä¸€å¸¸é‡å®šä¹‰ | âœ… | æ–°å¢ `fixtures/constants.py` |
| **TODO-IT-011** | ç»Ÿä¸€æ—¶é—´å¸¸é‡ | âœ… | åœ¨ `constants.py` ä¸­ |

### â³ å¾…å®Œæˆä»»åŠ¡

| TODO ID | ä»»åŠ¡æè¿° | çŠ¶æ€ |
|---------|----------|------|
| **TODO-IT-005** | EventBus åˆ†è£‚æµ‹è¯• | â³ æœªå¼€å§‹ |
| **TODO-IT-009** | Heartbeat è¶…æ—¶è¾¹ç•Œæµ‹è¯• | â³ æœªå¼€å§‹ |
| **TODO-IT-010** | æ›´å¤š Pipeline åœºæ™¯æµ‹è¯• | â³ æœªå¼€å§‹ |

---

## äºŒã€ä¼˜ç§€äº®ç‚¹ âœ…

### 2.1 Legacy ä»£ç æ¸…ç†å½»åº•
- ç§»é™¤äº† `USE_PIPELINE` ç¯å¢ƒå˜é‡æ£€æŸ¥
- ç§»é™¤äº† `use_pipeline` fixture
- ç®€åŒ–äº†æ—¥å¿—è¾“å‡ºï¼š`"ğŸš€ Integration tests running in V2 AgentPipeline mode"`

### 2.2 å¸¸é‡ç»Ÿä¸€ç®¡ç†
åˆ›å»ºäº† `fixtures/constants.py`ï¼ŒåŒ…å«ï¼š
```python
CONTAINER_CLIENT_A, CONTAINER_CLIENT_B, CONTAINER_CLIENT_C
MOUNT_POINT, AUDIT_INTERVAL, SENTINEL_INTERVAL
SESSION_TIMEOUT, HEARTBEAT_INTERVAL
TEST_TIMEOUT, CONTAINER_HEALTH_TIMEOUT
```

### 2.3 HTTP 419 é”™è¯¯å¤„ç†å®ç°å®Œæ•´

å®ç°äº†å®Œæ•´çš„ 419 é”™è¯¯å¤„ç†é“¾è·¯ï¼š
```
Fusion API (session.py)
    â†“ è¿”å› 419
FusionClient (fusion-sdk/client.py)
    â†“ re-raise HTTPStatusError
HTTPSender (sender-http/__init__.py)
    â†“ æ•è·å¹¶æŠ›å‡º SessionObsoletedError
AgentPipeline
    â†“ å¤„ç† SessionObsoletedErrorï¼Œé‡æ–°åˆ›å»º Session
```

### 2.4 WatchManager æ”¹è¿›
`_WatchManager.start()` ç°åœ¨æ”¯æŒï¼š
- æ£€æµ‹çº¿ç¨‹æ˜¯å¦å·²åœ¨è¿è¡Œ
- é‡æ–°åˆ›å»º inotify å®ä¾‹
- ä» LRU ç¼“å­˜æ¢å¤å·²æœ‰çš„ watches

### 2.5 æµ‹è¯•ä¿®å¤
- æ ‘éå†é€»è¾‘ï¼šä½¿ç”¨ `wait_for_file_in_tree()` æ›¿ä»£æ‰‹åŠ¨éå†
- Agent ID åŒ¹é…ï¼šä¿®å¤æ‰€æœ‰ `"agent-a"` â†’ `"client-a"` çš„é—®é¢˜
- åˆ é™¤è°ƒè¯•æ–‡ä»¶ï¼š`test_httpx.py` å·²åˆ é™¤

---

## ä¸‰ã€å‘ç°çš„é—®é¢˜ ğŸ”´

### âš ï¸ ä¸¥é‡é—®é¢˜

#### é—®é¢˜ S1: æµ‹è¯•æ±¡æŸ“ä¸šåŠ¡ä»£ç  - Delete Session è¿”å› 419 (å·²ä¿®å¤ âœ…)

**ä½ç½®**: `fusion/src/fustor_fusion/api/session.py`

**ç°çŠ¶**: å·²æ”¹ä¸ºè¿”å› 200 OK (å¹‚ç­‰å¤„ç†)ï¼Œå½»åº•è§£å†³äº†æµ‹è¯•æ±¡æŸ“é—®é¢˜ã€‚

---

#### é—®é¢˜ S2: Session API æ¡ä»¶é€»è¾‘å˜æ›´ (å·²ç¡®è®¤ä¸ºæ­£ç¡® âœ…)

**ä½ç½®**: `fusion/src/fustor_fusion/api/session.py`

**ç»“è®º**: ç»åˆ†æï¼Œæ­¤å˜æ›´ä¸º **æ­£ç¡®** çš„ä¿®å¤ã€‚
- **åŸå› **: ä¸ºäº†æ”¯æŒå¤š Agent å¹¶å‘æ¨é€ï¼Œ`allow_concurrent_push=True` æ—¶ä¸åº”é™åˆ¶å•ä¸€ Task Sessionã€‚
- **éªŒè¯**: æ­¤é€»è¾‘å…è®¸ä¸åŒ Agent æŒæœ‰ä¸åŒ Session ä½†ç›¸åŒ Task ID è¿›è¡Œå·¥ä½œï¼Œç¬¦åˆ V2 è®¾è®¡ç›®æ ‡ã€‚

---

### ğŸŸ¡ ä¸­ç­‰é—®é¢˜

#### é—®é¢˜ M1: æ‹¼å†™é”™è¯¯ `"obeselete"` (å·²ä¿®å¤ âœ…)

---

#### é—®é¢˜ M2: Agent é…ç½®ç¡¬ç¼–ç ç«¯å£å· (å·²ä¿®å¤ âœ…)

**ç°çŠ¶**: å·²åœ¨ `constants.py` ä¸­å®šä¹‰ `FUSION_ENDPOINT` å¹¶ç»Ÿä¸€å¼•ç”¨ã€‚

---

#### é—®é¢˜ M3: Session Recovery æµ‹è¯•æ–­è¨€æ”¾å®½å¯èƒ½è¿‡åº¦ (å·²æ·»åŠ æ³¨é‡Š âœ…)

**ä½ç½®**: `it/consistency/test_a3_session_recovery.py`, Line 70-71

**å˜æ›´**:
```python
# Before
assert role == "leader", ...

# After
assert role in ["leader", "follower"], ...
```

**å»ºè®®**: æ·»åŠ æ³¨é‡Šè§£é‡Šä¸ºä»€ä¹ˆæ”¾å®½æ–­è¨€

---

#### é—®é¢˜ M4: WatchManager é”ä½¿ç”¨ä¸ä¸€è‡´ (å·²ä¿®å¤ âœ…)

**ç°çŠ¶**: å·²æ·»åŠ é”ä¿æŠ¤å’ŒåŒé‡æ£€æŸ¥é”å®šã€‚

---

#### é—®é¢˜ M5: Sentinel æµ‹è¯•æ–­è¨€ä¸å¤Ÿç²¾ç¡® (å·²ä¿®å¤ âœ…)

**ç°çŠ¶**: å·²æ”¹ä¸ºä½¿ç”¨ `wait_for_flag` éªŒè¯ `integrity_suspect` çŠ¶æ€ã€‚

---

### ğŸŸ¢ è½»å¾®é—®é¢˜

#### é—®é¢˜ L1: `audit_iter` tuple å¤„ç†ç¼ºå°‘æ³¨é‡Š

**ä½ç½®**: `agent/src/fustor_agent/runtime/agent_pipeline.py`, Line 592-596

```python
async for item in audit_iter:
    if isinstance(item, tuple):
        event = item[0]
    else:
        event = item
```

**å»ºè®®**: æ·»åŠ æ³¨é‡Šè¯´æ˜ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªæ£€æŸ¥

---

#### é—®é¢˜ L2: `exec_in_container_with_retry` åºŸå¼ƒæ–¹æ³•ä¿ç•™

**ä½ç½®**: `it/utils/docker_manager.py`

**å»ºè®®**: å¦‚æœæ²¡æœ‰å¤–éƒ¨è°ƒç”¨ï¼Œåº”è¯¥ç§»é™¤æ­¤æ–¹æ³•

---

## å››ã€æ”¹è¿›å»ºè®®æ¸…å•

### ç«‹å³ä¿®å¤ (P0)

| # | å»ºè®® | æ–‡ä»¶ |
|---|------|------|
| 1 | âš ï¸ **æ¢å¤ Delete Session çš„ 404 è¿”å›ç ** | `fusion/api/session.py` |
| 2 | ä¿®å¤æ‹¼å†™é”™è¯¯ `obeselete` â†’ `obsolete` | `sender-http/__init__.py` |
| 3 | ç¡®è®¤ Session API `allow_concurrent_push` å˜æ›´æ„å›¾ | `fusion/api/session.py` |

### çŸ­æœŸä¼˜åŒ– (P1)

| # | å»ºè®® | æ–‡ä»¶ |
|---|------|------|
| 4 | å°† `FUSION_PORT` æ·»åŠ åˆ° `constants.py` | `fixtures/constants.py` |
| 5 | å¢å¼º Sentinel æµ‹è¯•æ–­è¨€ç²¾ç¡®åº¦ | `test_c5_sentinel_sweep.py` |
| 6 | åœ¨ `stop()` æ–¹æ³•ä¸­æ·»åŠ é”ä¿æŠ¤ | `components.py` |
| 7 | ä½¿ç”¨ double-checked locking ä¿æŠ¤ `_ensure_inotify` | `components.py` |
| 8 | ä¸º `audit_iter` tuple å¤„ç†æ·»åŠ æ³¨é‡Š | `agent_pipeline.py` |
| 9 | è¡¥å…… Session Recovery æµ‹è¯•æ–­è¨€æ³¨é‡Š | `test_a3_session_recovery.py` |

### é•¿æœŸæ”¹è¿› (P2)

| # | å»ºè®® |
|---|------|
| 10 | å®Œæˆå‰©ä½™ TODO ä»»åŠ¡ (EventBus åˆ†è£‚æµ‹è¯•ã€Heartbeat è¾¹ç•Œæµ‹è¯•) |
| 11 | ç»Ÿä¸€å¼‚å¸¸å¤„ç†ç­–ç•¥ (SDK å±‚ vs Sender å±‚) |
| 12 | æ·»åŠ  CI æµæ°´çº¿è‡ªåŠ¨è¿è¡Œé›†æˆæµ‹è¯• |

---

## äº”ã€è¿è¡Œæµ‹è¯•éªŒè¯

```bash
# è¿è¡Œæ‰€æœ‰é›†æˆæµ‹è¯•
cd it && uv run pytest consistency/ -v

# è¿è¡Œä¿®å¤åçš„æµ‹è¯•
cd it && uv run pytest consistency/test_c5_sentinel_sweep.py consistency/test_a3_session_recovery.py -vs

# è¿è¡Œæ‰€æœ‰ Agent ID ç›¸å…³æµ‹è¯•
cd it && uv run pytest consistency/test_a*.py consistency/test_e*.py -v
```

---

## å…­ã€æ€»ç»“

### æ•´ä½“è¯„ä»·

| æŒ‡æ ‡ | Commit dc9684b | Commit be8d030 | æœ€ç»ˆ |
|------|----------------|----------------|------|
| ä»»åŠ¡å®Œæˆåº¦ | 70% | 100% (é«˜ä¼˜å…ˆçº§) | âœ… ä¼˜ç§€ |
| ä»£ç è´¨é‡ | ğŸŸ¡ ä¸­ç­‰ | ğŸŸ¡ è‰¯å¥½ | ğŸŸ¡ è‰¯å¥½ |
| æµ‹è¯•è¦†ç›– | âœ… è‰¯å¥½ | âœ… å®Œæ•´ | âœ… å®Œæ•´ |
| Legacy æ¸…ç† | âœ… å®Œæˆ | âœ… å®Œæˆ | âœ… å®Œæˆ |

### æ–°æ‰‹ç¨‹åºå‘˜è¡¨ç°è¯„ä»·

**æ•´ä½“è¡¨ç°**: â­â­â­â­ (è‰¯å¥½)

**ä¼˜ç‚¹**:
- âœ… æŒ‰ç…§ TODO æ¸…å•å®Œæˆäº†å¤§éƒ¨åˆ†ä»»åŠ¡
- âœ… ä»£ç ç»“æ„æ¸…æ™°
- âœ… å®ç°äº†å®Œæ•´çš„ 419 é”™è¯¯å¤„ç†é“¾è·¯
- âœ… æ­£ç¡®ä¿®å¤äº†æ‰€æœ‰ Agent ID åŒ¹é…é—®é¢˜
- âœ… åˆ é™¤äº†è°ƒè¯•æ–‡ä»¶

**éœ€è¦æ”¹è¿›**:
1. âš ï¸ **æµ‹è¯•æ±¡æŸ“ä¸šåŠ¡ä»£ç ** - æœ€ä¸¥é‡é—®é¢˜ï¼Œéœ€è¦ç†è§£ API è¯­ä¹‰å·®å¼‚
2. æ³¨æ„æ‹¼å†™æ£€æŸ¥
3. å¤šçº¿ç¨‹ä»£ç éœ€è¦æ›´ä»”ç»†è€ƒè™‘é”çš„ä½¿ç”¨
4. æ”¾å®½æµ‹è¯•æ–­è¨€æ—¶åº”æ·»åŠ æ³¨é‡Šè¯´æ˜åŸå› 
5. ä¸åŒ API æœ‰ä¸åŒçš„è¡Œä¸ºï¼Œä¸èƒ½æœºæ¢°åœ°ç»Ÿä¸€å¤„ç†

### æœ€é«˜ä¼˜å…ˆçº§è¡ŒåŠ¨

1. **ä¿®å¤** Delete Session çš„è¿”å›ç  (419 â†’ 404)
2. **ä¿®å¤** æ‹¼å†™é”™è¯¯
3. **è¿è¡Œæµ‹è¯•éªŒè¯**

---

## é™„å½•ï¼šæµ‹è¯•æ±¡æŸ“ä¸šåŠ¡ä»£ç è­¦ç¤º

### é”™è¯¯æ¨¡å¼
```
æµ‹è¯•å¤±è´¥ 
  â†’ æ–°æ‰‹ç¨‹åºå‘˜ä¿®æ”¹ä¸šåŠ¡ä»£ç è®©æµ‹è¯•é€šè¿‡
  â†’ ä½†ç ´åäº†ä¸šåŠ¡é€»è¾‘çš„æ­£ç¡®æ€§
```

### æ­£ç¡®çš„åšæ³•
å½“æµ‹è¯•å¤±è´¥æ—¶ï¼Œåº”è¯¥å…ˆé—®è‡ªå·±ï¼š
1. **æµ‹è¯•æœŸæœ›æ˜¯å¦æ­£ç¡®ï¼Ÿ** - ä¹Ÿè®¸æµ‹è¯•æœ¬èº«æœ‰é—®é¢˜
2. **ä¸šåŠ¡é€»è¾‘æ˜¯å¦æ­£ç¡®ï¼Ÿ** - ä¸è¦ä¸ºäº†æµ‹è¯•é€šè¿‡è€Œä¿®æ”¹æ­£ç¡®çš„ä¸šåŠ¡ä»£ç 
3. **æˆ‘æ˜¯å¦ç†è§£äº† API çš„è¯­ä¹‰ï¼Ÿ** - ä¸åŒ API å¯èƒ½æœ‰ä¸åŒçš„è¡Œä¸º
