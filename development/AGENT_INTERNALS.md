# Agent 内部机制与维护

本文档解释了 Fustor Agent 的一些核心内部工作机制，以及如何在生产环境中进行维护和故障排查。

## 1. Schema 缓存

### 机制
为了优化性能和减少对源数据库的重复请求，Fustor Agent 会在第一次成功连接并发现数据源的字段后，将这些信息缓存到本地文件系统。

*   **缓存位置**: `~/.fustor/schema_cache/`

### 维护
*   **手动触发**: 您可以通过命令行 `fustor_agent discover-schema --source-id <your-source-id>` 来手动触发特定数据源的 schema 发现与缓存。
*   **自动禁用**: 如果应用启动时发现某个已启用的同步任务其数据源缺少 schema 缓存，该任务将被**自动禁用**，以防止启动失败。您需要通过 Web UI 的配置向导或上述命令行重新生成缓存来恢复它。

## 2. 运行时状态持久化

### 机制
Fustor Agent 将所有正在运行的任务实例（包括同步任务和事件总线）的状态实时保存在一个 JSON 文件中。

*   **文件位置**: `~/.fustor/fustor_agent.state.json`
*   **崩溃恢复**: 此文件是实现崩溃恢复的关键。当应用重启时，它会读取此文件，尝试恢复并重启之前正在运行的任务。

### 维护
*   **状态重置**: 如果您需要完全重置所有任务的运行时状态（例如，在调试或遇到无法恢复的错误时），最直接的方法是：
    1.  **停止 Fustor Agent 服务** (`fustor-agent stop`)。
    2.  **删除 `~/.fustor/fustor_agent.state.json` 文件**。
    3.  **重新启动 Agent 服务** (`fustor-agent start -D`)。

## 3. 调试与日志

*   **日志路径**: 默认日志文件位于 `~/.fustor/agent.log`。您可以通过 `FUSTOR_CONFIG_DIR` 环境变量修改配置和日志的根目录。
*   **结构化查询**: Agent 提供了强大的结构化日志 API，支持按日志级别、组件名称进行筛选和分页查询，极大地简化了问题排查和日常监控。
*   **Prometheus 指标**: 内置 `/metrics` 端点，以 Prometheus 格式导出核心性能指标，如事件生产/消费速率、事件总线队列大小、推送延迟等，方便接入现有的监控告警体系。
