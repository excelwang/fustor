# 11 - 测试与评审最佳实践 (Testing & Review Best Practices)

> "不要让测试成为掩盖 Bug 的『帮凶』。"

在 Fustor 的开发过程中，我们发现某些严重的运行期错误（如 `AttributeError`）被单元测试完美绕过。本指南总结了此类教训，为后续的开发与评审提供参考。

## 1. 警惕 "测试驱动的幸存者偏差" (Test-Driven Survival)

测试的任务是**暴露**问题，而不是通过 "补丁" 让代码**看起来**没问题。

### 1.1 禁止不健康的属性注入
**反面案例**：
```python
# 测试代码中
pipe = FusionPipe(pipe_id="test", config={})
pipe.pipe_id = pipe.id  # 🔴 警告：手动给对象补齐一个它本来没有的属性
```
**后果**：代码在真实环境下运行会因为缺少该属性而崩溃（AttributeError），但因为测试中手动注入了该属性，测试会 100% 通过。

**最佳实践**：
- 测试 Fixture 必须严格模拟真实对象的创建过程。
- 除非是为了隔离外部依赖（Mocking），否则禁止手动修改对象的内部状态来规避报错。
- 如果发现代码报错，优先检查**代码本身**的逻辑或属性命名，而不是在测试里加补丁。

## 2. 接口与契约的严格一致性

Fustor 采用分层解耦架构（L0-L3），层与层之间的契约（Contract）必须绝对一致。

### 2.1 禁止魔法命名 (The "pipe_id" Lesson)
- **基类属性名** 是唯一的真实来源。
- 如果基类定义为 `self.id`，派生类和所有引用处严禁猜测或臆造 `self.pipe_id`。
- **评审重点**：在 Code Review 时，重点检查 `self.xxx` 访问的属性是否确实存在于基类或当前类中。

### 2.2 委托链的完整穿透
- 在 `Adapter` 模式中，确保 `**kwargs` 能够无损地从入口点穿透到最终的 `Driver`。
- **测试重点**：编写测试用例时，应故意传递一些非标准参数，验证系统是否会因为无法识别这些参数而抛出 `TypeError`。

## 3. 评审注意事项单 (Review Checklist)

1.  **Mock 审计**：检查测试代码中是否有对业务逻辑类手动设置属性 (`setattr`) 的行为。
2.  **属性一致性**：验证派生类中的 `super().__init__` 与参数使用是否符合基类定义。
3.  ** terminology check**：检查注释和 Docstring 是否与最新版本架构对齐（例如 `pipe_id` vs `view_id`）。
4.  **影子错误隔离**：确保测试失败时，报错信息是指向真实的接口不匹配，而不是被测试框架或 Mock 框架捕获后转换为了模糊的错误。

## 4. 总结

高质量的测试不仅要覆盖功能，更要验证**结构的正确性**。拒绝为了 "绿灯" 而进行的任何测试补丁，宁可让测试失败，也要真实反映代码的生产环境状态。
