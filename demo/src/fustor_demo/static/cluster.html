<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fustor Cluster Dashboard</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <style>
        @keyframes pulse-ring {
            0% { transform: scale(.33); opacity: 1; }
            80%, 100% { transform: scale(1.2); opacity: 0; }
        }
        .node-pulse::before {
            content: '';
            display: block;
            position: absolute;
            width: 100%; height: 100%;
            border-radius: 50%;
            background-color: inherit;
            animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
        .data-flow {
            stroke-dasharray: 10;
            animation: dash 5s linear infinite;
        }
        @keyframes dash {
            from { stroke-dashoffset: 100; }
            to { stroke-dashoffset: 0; }
        }
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen p-8">
        <header class="flex justify-between items-center mb-12 border-b border-slate-700 pb-6">
            <div>
                <h1 class="text-3xl font-bold text-sky-400">Fustor <span class="text-slate-100">Cluster Dashboard</span></h1>
                <p class="text-slate-400 mt-1">REAL-TIME Cluster Visualization (3-Node Docker Setup)</p>
            </div>
            <div class="flex gap-4">
                <div class="bg-slate-800 px-4 py-2 rounded-lg border border-slate-700">
                    <span class="text-xs text-slate-500 block uppercase font-semibold">Live Agents</span>
                    <span class="text-xl font-mono">{{ agents.length }}</span>
                </div>
                <div class="bg-slate-800 px-4 py-2 rounded-lg border border-slate-700">
                    <span class="text-xs text-slate-500 block uppercase font-semibold">Fusion Core</span>
                    <span class="text-xl text-green-400 font-mono">ONLINE</span>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left: Cluster Topology -->
            <div class="lg:col-span-2 bg-slate-800/50 rounded-2xl border border-slate-700 p-6 relative overflow-hidden">
                <h2 class="text-xl font-semibold mb-6 flex items-center">
                    <i class="bi bi-diagram-3-fill me-2 text-sky-400"></i> Docker Cluster Topology
                </h2>
                
                <div class="relative h-[500px] flex items-center justify-center">
                    <!-- Central Fusion Core -->
                    <div class="relative z-10">
                        <div class="w-32 h-32 bg-sky-500 rounded-full flex flex-col items-center justify-center shadow-[0_0_50px_rgba(14,165,233,0.3)] border-4 border-slate-900">
                            <i class="bi bi-cpu-fill text-4xl mb-1"></i>
                            <span class="text-[10px] font-bold uppercase">Fusion Container</span>
                        </div>
                    </div>

                    <!-- Agent Nodes -->
                    <div v-for="(agent, idx) in agents" :key="agent.id" 
                         :style="getNodeStyle(idx, agents.length)"
                         class="absolute flex flex-col items-center transition-all duration-500">
                        <div :class="agent.role === 'leader' ? 'bg-amber-500' : 'bg-indigo-500'" 
                             class="w-16 h-16 rounded-xl flex items-center justify-center shadow-lg border-2 border-slate-900 node-pulse relative">
                            <i class="bi bi-box-fill text-2xl"></i>
                        </div>
                        <div class="mt-3 text-center">
                            <div class="text-xs font-bold font-mono">{{ agent.name }}</div>
                            <div class="text-[9px] uppercase tracking-wider px-2 py-0.5 rounded mt-1" 
                                 :class="agent.role === 'leader' ? 'bg-amber-500/20 text-amber-400' : 'bg-indigo-500/20 text-indigo-400'">
                                {{ agent.role }}
                            </div>
                            <div class="text-[8px] text-slate-500 font-mono">{{ agent.ip }}</div>
                        </div>
                    </div>

                    <!-- Flow Lines -->
                    <svg class="absolute inset-0 w-full h-full pointer-events-none">
                        <line v-for="(agent, idx) in agents" :key="'l-'+idx"
                              :x1="50 + '%' " :y1="50 + '%'"
                              :x2="getNodePos(idx, agents.length).x" :y2="getNodePos(idx, agents.length).y"
                              stroke="#334155" stroke-width="2" class="data-flow" />
                    </svg>
                </div>
            </div>

            <!-- Right: Cluster Events & Logs -->
            <div class="space-y-8">
                <!-- Real-time Events -->
                <div class="bg-slate-800/50 rounded-2xl border border-slate-700 p-6 h-[600px] flex flex-col">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="bi bi-activity me-2 text-rose-400"></i> Unified File Feed
                    </h2>
                    <div class="flex-1 overflow-y-auto space-y-3 pr-2 scrollbar-thin">
                        <div v-for="event in events" :key="event.id" 
                             class="bg-slate-900/50 p-3 rounded-lg border-l-4 transition-all animate-in slide-in-from-right"
                             :class="event.source_type === 'file' ? 'border-sky-500' : 'border-slate-500'">
                            <div class="flex justify-between items-start mb-1">
                                <span class="text-xs font-mono text-slate-500">{{ formatTime(event.last_modified) }}</span>
                                <span class="text-[10px] uppercase font-bold px-1.5 rounded bg-slate-800 text-sky-400">{{ event.source_type }}</span>
                            </div>
                            <div class="text-sm truncate font-medium">{{ event.name }}</div>
                            <div class="text-[10px] text-slate-500 font-mono truncate">{{ event.path }}</div>
                        </div>
                        <div v-if="!events.length" class="text-center text-slate-600 mt-20">
                            Waiting for file changes...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Unified Tree Status -->
        <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div v-for="source in sourceSummary" :key="source.name" 
                 class="bg-slate-800 border border-slate-700 p-4 rounded-xl flex items-center">
                <div :class="source.color" class="w-10 h-10 rounded-lg flex items-center justify-center me-4">
                    <i :class="source.icon" class="text-xl"></i>
                </div>
                <div>
                    <div class="text-xs text-slate-500 uppercase font-bold">{{ source.name }}</div>
                    <div class="text-xl font-mono">{{ source.count }} <span class="text-xs text-slate-400 font-sans">count</span></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    agents: [],
                    events: [],
                    sourceSummary: [
                        { name: 'Total Agent Nodes', icon: 'bi-server', color: 'bg-sky-500/20 text-sky-400', count: 0, type: 'nodes' },
                        { name: 'Unified Files Count', icon: 'bi-files', color: 'bg-emerald-500/20 text-emerald-400', count: 0, type: 'files' }
                    ]
                }
            },
            methods: {
                async fetchClusterState() {
                    try {
                        const res = await fetch('/api/real_cluster_state');
                        const data = await res.json();
                        
                        if (data.error) throw new Error(data.error);

                        // 1. Map real sessions to agents
                        this.agents = data.sessions.map(s => ({
                            id: s.session_id,
                            name: 'Agent-' + s.agent_id.substring(0, 4),
                            role: s.role,
                            ip: s.client_ip
                        }));

                        // 2. Map real tree children to events (file feed)
                        this.events = data.tree.map(f => ({
                            id: f.path,
                            name: f.name,
                            source_type: f.content_type,
                            path: f.path,
                            last_modified: f.modified_time * 1000 // Convert to MS
                        })).sort((a,b) => b.last_modified - a.last_modified);

                        // 3. Update summary
                        this.sourceSummary[0].count = this.agents.length;
                        this.sourceSummary[1].count = this.events.length;

                    } catch (e) {
                        console.error("Failed to fetch real cluster state", e);
                    }
                },
                getNodeStyle(idx, total) {
                    const pos = this.getNodePos(idx, total);
                    return { left: pos.x, top: pos.y };
                },
                getNodePos(idx, total) {
                    const angle = (idx / total) * 2 * Math.PI - (Math.PI / 2);
                    const x = 50 + (Math.cos(angle) * 35); // %
                    const y = 50 + (Math.sin(angle) * 35); // %
                    return { x: x + '%', y: y + '%' };
                },
                formatTime(timestamp) {
                    if(!timestamp) return '--:--:--';
                    return new Date(timestamp).toLocaleTimeString([], { hour12: false });
                }
            },
            mounted() {
                this.fetchClusterState();
                setInterval(this.fetchClusterState, 2000);
            }
        }).mount('#app')
    </script>
</body>
</html>