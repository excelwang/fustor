# version is obsolete in compose v2
# Fustor NFS Multi-Mount Consistency Integration Test Environment

# Fustor NFS Multi-Mount Consistency Integration Test Environment
# This setup simulates a real NFS multi-client scenario with:
# - NFS Server: exports shared directory
# - NFS Client A/B: with Fustor Agents (Leader/Follower)
# - NFS Client C: no Agent (blind-spot simulation)
# - Registry & Fusion: central services

services:
  # ============ Infrastructure Services ============

  nfs-server:
    image: erichough/nfs-server
    container_name: fustor-nfs-server
    privileged: true
    environment:
      NFS_EXPORT_0: "/exports *(rw,sync,no_subtree_check,no_root_squash)"
    volumes:
      - nfs-data:/exports
    networks:
      - fustor-net
    healthcheck:
      test: [ "CMD", "showmount", "-e", "localhost" ]
      interval: 5s
      timeout: 3s
      retries: 30

  registry:
    build:
      context: ..
      dockerfile: tests/containers/fustor-services/Dockerfile
    container_name: fustor-registry
    command: [ "fustor-registry", "start", "-h", "0.0.0.0" ]
    environment:
      FUSTOR_REGISTRY_HOST: "0.0.0.0"
      FUSTOR_REGISTRY_PORT: "8101"
      FUSTOR_REGISTRY_DATA_DIR: "/data/registry"
      FUSTOR_REGISTRY_ADMIN_PASSWORD: "admin123"
      # Shared token for internal service communication
      FUSTOR_REGISTRY_CLIENT_TOKEN: "test-integration-token-for-internal-apis-12345"
      FUSTOR_CORE_SECRET_KEY: "test-integration-secret-key-for-jwt-signing"
    volumes:
      - registry-data:/data/registry
    ports:
      - "18101:8101"
    networks:
      - fustor-net
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8101/" ]
      interval: 5s
      timeout: 3s
      retries: 30

  fusion:
    build:
      context: ..
      dockerfile: tests/containers/fustor-services/Dockerfile
    container_name: fustor-fusion
    command: [ "fustor-fusion", "start", "-h", "0.0.0.0" ]
    environment:
      FUSTOR_FUSION_HOST: "0.0.0.0"
      FUSTOR_FUSION_PORT: "8102"
      FUSTOR_FUSION_REGISTRY_URL: "http://registry:8101"
      FUSTOR_FUSION_DATA_DIR: "/data/fusion"
      # Faster cache sync for integration tests
      FUSTOR_FUSION_API_KEY_CACHE_SYNC_INTERVAL_SECONDS: "1"
      # Accelerate failover tests
      FUSTOR_FUSION_SESSION_TIMEOUT_SECONDS: "3"
      # Shared token for internal service communication (must match Registry)
      FUSTOR_REGISTRY_CLIENT_TOKEN: "test-integration-token-for-internal-apis-12345"
      FUSTOR_CORE_SECRET_KEY: "test-integration-secret-key-for-jwt-signing"
      FUSTOR_FUSION_CONFIG_PATH: "/data/config/fusion-config.yaml"
      FUSTOR_LOG_LEVEL: "DEBUG"
    volumes:
      - fusion-data:/data/fusion
      - ./config/fusion/config.yaml:/data/config/fusion-config.yaml
      - ../fusion/src/fustor_fusion:/usr/local/lib/python3.11/site-packages/fustor_fusion
      - ../packages/fustor_common/src/fustor_common:/usr/local/lib/python3.11/site-packages/fustor_common
      - ../packages/core/src/fustor_core:/usr/local/lib/python3.11/site-packages/fustor_core
      - ../packages/fustor_event_model/src/fustor_event_model:/usr/local/lib/python3.11/site-packages/fustor_event_model
      - ../packages/fustor_registry_client/src/fustor_registry_client:/usr/local/lib/python3.11/site-packages/fustor_registry_client
      - ../packages/fustor_fusion_sdk/src/fustor_fusion_sdk:/usr/local/lib/python3.11/site-packages/fustor_fusion_sdk
      - ../packages/view_fs/src/fustor_view_fs:/usr/local/lib/python3.11/site-packages/fustor_view_fs

    ports:
      - "18102:8102"
    networks:
      - fustor-net
    depends_on:
      registry:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8102/" ]
      interval: 5s
      timeout: 3s
      retries: 30

  # ============ NFS Clients with Agents ============

  nfs-client-a:
    build:
      context: ..
      dockerfile: tests/containers/nfs-client/Dockerfile
    container_name: fustor-nfs-client-a
    privileged: true
    cap_add:
      - SYS_ADMIN
    environment:
      NFS_SERVER: "nfs-server"
      NFS_PATH: "/exports"
      MOUNT_POINT: "/mnt/shared"
      MOUNT_OPTIONS: "actimeo=1,nolock"
      AGENT_ENABLED: "false"
      AGENT_ID: "agent-a"
      AGENT_PORT: "8100"
      FUSION_ENDPOINT: "http://fusion:8102"
      REGISTRY_ENDPOINT: "http://registry:8101"
    volumes:
      - agent-a-data:/data/agent
      - ../agent/src/fustor_agent:/usr/local/lib/python3.11/site-packages/fustor_agent
      - ../packages/source_fs/src/fustor_source_fs:/usr/local/lib/python3.11/site-packages/fustor_source_fs
      - ../packages/pusher_fusion/src/fustor_pusher_fusion:/usr/local/lib/python3.11/site-packages/fustor_pusher_fusion
      - ../packages/fustor_common/src/fustor_common:/usr/local/lib/python3.11/site-packages/fustor_common
      - ../packages/core/src/fustor_core:/usr/local/lib/python3.11/site-packages/fustor_core
      - ../packages/fustor_event_model/src/fustor_event_model:/usr/local/lib/python3.11/site-packages/fustor_event_model
      - ../packages/fustor_agent_sdk/src/fustor_agent_sdk:/usr/local/lib/python3.11/site-packages/fustor_agent_sdk
      - ../packages/fustor_fusion_sdk/src/fustor_fusion_sdk:/usr/local/lib/python3.11/site-packages/fustor_fusion_sdk
    ports:
      - "18100:8100"
    networks:
      - fustor-net
    depends_on:
      nfs-server:
        condition: service_healthy
      fusion:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "test", "-d", "/mnt/shared" ]
      interval: 5s
      timeout: 3s
      retries: 30

  nfs-client-b:
    build:
      context: ..
      dockerfile: tests/containers/nfs-client/Dockerfile
    container_name: fustor-nfs-client-b
    privileged: true
    cap_add:
      - SYS_ADMIN
    environment:
      NFS_SERVER: "nfs-server"
      NFS_PATH: "/exports"
      MOUNT_POINT: "/mnt/shared"
      MOUNT_OPTIONS: "actimeo=1,nolock"
      AGENT_ENABLED: "false"
      AGENT_ID: "agent-b"
      AGENT_PORT: "8100"
      FUSION_ENDPOINT: "http://fusion:8102"
      REGISTRY_ENDPOINT: "http://registry:8101"
    volumes:
      - agent-b-data:/data/agent
      - ../agent/src/fustor_agent:/usr/local/lib/python3.11/site-packages/fustor_agent
      - ../packages/source_fs/src/fustor_source_fs:/usr/local/lib/python3.11/site-packages/fustor_source_fs
      - ../packages/pusher_fusion/src/fustor_pusher_fusion:/usr/local/lib/python3.11/site-packages/fustor_pusher_fusion
      - ../packages/fustor_common/src/fustor_common:/usr/local/lib/python3.11/site-packages/fustor_common
      - ../packages/core/src/fustor_core:/usr/local/lib/python3.11/site-packages/fustor_core
      - ../packages/fustor_event_model/src/fustor_event_model:/usr/local/lib/python3.11/site-packages/fustor_event_model
      - ../packages/fustor_agent_sdk/src/fustor_agent_sdk:/usr/local/lib/python3.11/site-packages/fustor_agent_sdk
      - ../packages/fustor_fusion_sdk/src/fustor_fusion_sdk:/usr/local/lib/python3.11/site-packages/fustor_fusion_sdk
    ports:
      - "18103:8100"
    networks:
      - fustor-net
    depends_on:
      nfs-server:
        condition: service_healthy
      fusion:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "test", "-d", "/mnt/shared" ]
      interval: 5s
      timeout: 3s
      retries: 30

  # ============ NFS Client without Agent (Blind-spot Simulation) ============

  nfs-client-c:
    build:
      context: ..
      dockerfile: tests/containers/nfs-client/Dockerfile
    container_name: fustor-nfs-client-c
    privileged: true
    cap_add:
      - SYS_ADMIN
    environment:
      NFS_SERVER: "nfs-server"
      NFS_PATH: "/exports"
      MOUNT_POINT: "/mnt/shared"
      MOUNT_OPTIONS: "actimeo=1,nolock"
      AGENT_ENABLED: "false"
    networks:
      - fustor-net
    depends_on:
      nfs-server:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "test", "-d", "/mnt/shared" ]
      interval: 5s
      timeout: 3s
      retries: 30

networks:
  fustor-net:
    driver: bridge

volumes:
  nfs-data:
  registry-data:
  fusion-data:
  agent-a-data:
  agent-b-data:
